# Caddyfile - Automatic HTTPS reverse proxy
# Caddy automatically obtains and renews Let's Encrypt certificates

{$DOMAIN} {
    # Reverse proxy to Go server
    reverse_proxy server:8080

    # Security headers
    header {
        # HSTS - enforce HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "DENY"
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        # XSS protection
        X-XSS-Protection "1; mode=block"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server header
        -Server
    }

    # Logging
    log {
        output stdout
        format json
    }

    # Health check endpoint (no logging)
    handle /health {
        reverse_proxy server:8080
    }
}

# Redirect www to non-www
www.{$DOMAIN} {
    redir https://{$DOMAIN}{uri} permanent
}
